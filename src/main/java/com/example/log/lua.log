
local function acquire(key, permits, curr_mill_second) local rate_limit_info = redis.pcall('HMGET', key, 'last_mill_second', 'curr_permits', 'max_permits', 'period'); local last_mill_second = rate_limit_info[1]; local curr_permits = tonumber(rate_limit_info[2]); local max_permits = tonumber(rate_limit_info[3]); local period = rate_limit_info[4];  if (max_permits == nil) then return 1; end local local_curr_permits = max_permits;  if (type(last_mill_second) ~= 'boolean' and last_mill_second ~= nil) then local reverse_permits = math.floor((curr_mill_second - last_mill_second) / (period * 1000)) * max_permits; local expect_curr_permits = reverse_permits + curr_permits; local_curr_permits = math.min(expect_curr_permits, max_permits); last_mill_second if (reverse_permits > 0) then redis.pcall('HSET', key, 'last_mill_second', curr_mill_second); end else redis.pcall('HSET', key, 'last_mill_second', curr_mill_second); end local result = {}; if (local_curr_permits - permits >= 0) then result.permit = local_curr_permits - permits; result.cert_id = redis.pcall('HGET', key, 'cert_id'); redis.pcall('HSET', key, 'curr_permits', local_curr_permits - permits); else  redis.pcall('HSET', key, 'curr_permits', 0); end return result; end return acquire('asd:asd','1','1615192828000')


[root@hk-1 v2.bytexuan.com]# php composer.phar install
Loading composer repositories with package information
Warning from https://mirrors.aliyun.com/composer: You are using an outdated version of Composer. Composer 2 is now available and you should upgrade. See https://getcomposer.org/2
Updating dependencies (including require-dev)

#百信
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDd0MAGJs11vqk0n8QllKJTKnIoL8r+hXuGKPl6EP74XQI+fe8Oy/krbPVrhtHxBUxJ/EzKciGdGd+JO8yTjG/kI3G5pzSrfF4afMgXy4wc8itz0Gcs+ig7jzr670s4VPHHEEpe63oWjXKFkJ3yEfzu6bVScUZeQI1URH6wVfrpwwIDAQAB

发送的
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDSwmvBMn4HsP5jwjLarW96LjdWgIwWcX5Wu8sGxFCiE9Ch8GKbMvFpUjpuUXYV0N1SlzOJGJynblhx22WBSYEUPckrGDnGiUD/TC+/drGASLvg2ANmlnCgFjgktCSfqXTe3YljkKM3/rOBZbBYSDSXCD3ey9TSlTEHf+/dxvaR3QIDAQAB
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDSwmvBMn4HsP5jwjLarW96LjdWgIwWcX5Wu8sGxFCiE9Ch8GKbMvFpUjpuUXYV0N1SlzOJGJynblhx22WBSYEUPckrGDnGiUD/TC+/drGASLvg2ANmlnCgFjgktCSfqXTe3YljkKM3/rOBZbBYSDSXCD3ey9TSlTEHf+/dxvaR3QIDAQAB

DQEBAQUAA4GNADCBiQKBgQDfTAiHxhKLF660q6rdYeLvQDQteLeux1BvJqtmA+7NlfVe9RfTTPcGhs+hDwTnJRkhnP2Lzn/IFGTYKk/ZwIAN0ow9yjJ3HBPvf0wJRRQj2htZBCJhBAnW6SRLlcBKuyqaVj0zOVmZZ2iArb/6RPamOOT4ghtoMpPTGTK4ZOy+5QIDAQAB

配置的
MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBANLCa8Eyfgew/mPCMtqtb3ouN1aAjBZxfla7ywbEUKIT0KHwYpsy8WlSOm5RdhXQ3VKXM4kYnKduWHHbZYFJgRQ9ySsYOcaJQP9ML792sYBIu+DYA2aWcKAWOCS0JJ+pdN7diWOQozf+s4FlsFhINJcIPd7L1NKVMQd/793G9pHdAgMBAAECgYAZBdZPUNRfy2bYp0Tsa60Rn40Yaxi2zXDHkXJQclx0cc/Sejzq2kiJTab8VBWmD29HkAYhX9exlUtQ8VCC4hw9+Mt12IoQLj34eAXvyetun1JtNtscmtcwqt4WjIove7jEn59dwpFBqlivYGpqaABZ4UgxoGBaN95liR+i+QJK4QJBAPBsKg40v1xSYm9MeK6RL2Nbn7aFahTDNT+uMSuUyJK65NZJsu5j/T5BlUgvIqUbIJWtM8ZS9Oop1A+tdCOCxmUCQQDgaj3wMhQHlbmE/y60BERNmolnfnb24FSxqk/U/7Of+tAAVwlvUPSOB5i1cmCPCb11jn/nJAN/HlEZCLwQ+EoZAkEA0Cw39fkCQMQs60YBsNWRfKyXDAlVIwkrkCoZ9Sxsx3AAOPOzdOsrGb7brZbynpdwjWldTToDSsZREgoUZ7MSaQJAaguqUyvG7UKiVSek8SonAKjrDz3ih4zAWOhLKzLdtdZ2ngKDEdgmiEssrWlsGYuXvMpmxFnvUQ2JcxP+kuJRWQJABhz0IgY+S9eSmZq3YlmL2GH5V/xZqbtG4mpSYet/9qD0oWUUgEGpBMXHUOu50WF/ldocSmXjRH7ZkdIxulKe1g==
MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBANLCa8Eyfgew/mPCMtqtb3ouN1aAjBZxfla7ywbEUKIT0KHwYpsy8WlSOm5RdhXQ3VKXM4kYnKduWHHbZYFJgRQ9ySsYOcaJQP9ML792sYBIu+DYA2aWcKAWOCS0JJ+pdN7diWOQozf+s4FlsFhINJcIPd7L1NKVMQd/793G9pHdAgMBAAECgYAZBdZPUNRfy2bYp0Tsa60Rn40Yaxi2zXDHkXJQclx0cc/Sejzq2kiJTab8VBWmD29HkAYhX9exlUtQ8VCC4hw9+Mt12IoQLj34eAXvyetun1JtNtscmtcwqt4WjIove7jEn59dwpFBqlivYGpqaABZ4UgxoGBaN95liR+i+QJK4QJBAPBsKg40v1xSYm9MeK6RL2Nbn7aFahTDNT+uMSuUyJK65NZJsu5j/T5BlUgvIqUbIJWtM8ZS9Oop1A+tdCOCxmUCQQDgaj3wMhQHlbmE/y60BERNmolnfnb24FSxqk/U/7Of+tAAVwlvUPSOB5i1cmCPCb11jn/nJAN/HlEZCLwQ+EoZAkEA0Cw39fkCQMQs60YBsNWRfKyXDAlVIwkrkCoZ9Sxsx3AAOPOzdOsrGb7brZbynpdwjWldTToDSsZREgoUZ7MSaQJAaguqUyvG7UKiVSek8SonAKjrDz3ih4zAWOhLKzLdtdZ2ngKDEdgmiEssrWlsGYuXvMpmxFnvUQ2JcxP+kuJRWQJABhz0IgY+S9eSmZq3YlmL2GH5V/xZqbtG4mpSYet/9qD0oWUUgEGpBMXHUOu50WF/ldocSmXjRH7ZkdIxulKe1g==


#合作方的私钥，妥善保存，生产和准生产环境相同。测试环境由百信银行提供测试（合作方也可以提出修改）
app.privateKey=
MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBANLCa8Eyfgew/mPCMtqtb3ouN1aAjBZxfla7ywbEUKIT0KHwYpsy8WlSOm5RdhXQ3VKXM4kYnKduWHHbZYFJgRQ9ySsYOcaJQP9ML792sYBIu+DYA2aWcKAWOCS0JJ+pdN7diWOQozf+s4FlsFhINJcIPd7L1NKVMQd/793G9pHdAgMBAAECgYAZBdZPUNRfy2bYp0Tsa60Rn40Yaxi2zXDHkXJQclx0cc/Sejzq2kiJTab8VBWmD29HkAYhX9exlUtQ8VCC4hw9+Mt12IoQLj34eAXvyetun1JtNtscmtcwqt4WjIove7jEn59dwpFBqlivYGpqaABZ4UgxoGBaN95liR+i+QJK4QJBAPBsKg40v1xSYm9MeK6RL2Nbn7aFahTDNT+uMSuUyJK65NZJsu5j/T5BlUgvIqUbIJWtM8ZS9Oop1A+tdCOCxmUCQQDgaj3wMhQHlbmE/y60BERNmolnfnb24FSxqk/U/7Of+tAAVwlvUPSOB5i1cmCPCb11jn/nJAN/HlEZCLwQ+EoZAkEA0Cw39fkCQMQs60YBsNWRfKyXDAlVIwkrkCoZ9Sxsx3AAOPOzdOsrGb7brZbynpdwjWldTToDSsZREgoUZ7MSaQJAaguqUyvG7UKiVSek8SonAKjrDz3ih4zAWOhLKzLdtdZ2ngKDEdgmiEssrWlsGYuXvMpmxFnvUQ2JcxP+kuJRWQJABhz0IgY+S9eSmZq3YlmL2GH5V/xZqbtG4mpSYet/9qD0oWUUgEGpBMXHUOu50WF/ldocSmXjRH7ZkdIxulKe1g==
MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBANLCa8Eyfgew/mPCMtqtb3ouN1aAjBZxfla7ywbEUKIT0KHwYpsy8WlSOm5RdhXQ3VKXM4kYnKduWHHbZYFJgRQ9ySsYOcaJQP9ML792sYBIu+DYA2aWcKAWOCS0JJ+pdN7diWOQozf+s4FlsFhINJcIPd7L1NKVMQd/793G9pHdAgMBAAECgYAZBdZPUNRfy2bYp0Tsa60Rn40Yaxi2zXDHkXJQclx0cc/Sejzq2kiJTab8VBWmD29HkAYhX9exlUtQ8VCC4hw9+Mt12IoQLj34eAXvyetun1JtNtscmtcwqt4WjIove7jEn59dwpFBqlivYGpqaABZ4UgxoGBaN95liR+i+QJK4QJBAPBsKg40v1xSYm9MeK6RL2Nbn7aFahTDNT+uMSuUyJK65NZJsu5j/T5BlUgvIqUbIJWtM8ZS9Oop1A+tdCOCxmUCQQDgaj3wMhQHlbmE/y60BERNmolnfnb24FSxqk/U/7Of+tAAVwlvUPSOB5i1cmCPCb11jn/nJAN/HlEZCLwQ+EoZAkEA0Cw39fkCQMQs60YBsNWRfKyXDAlVIwkrkCoZ9Sxsx3AAOPOzdOsrGb7brZbynpdwjWldTToDSsZREgoUZ7MSaQJAaguqUyvG7UKiVSek8SonAKjrDz3ih4zAWOhLKzLdtdZ2ngKDEdgmiEssrWlsGYuXvMpmxFnvUQ2JcxP+kuJRWQJABhz0IgY+S9eSmZq3YlmL2GH5V/xZqbtG4mpSYet/9qD0oWUUgEGpBMXHUOu50WF/ldocSmXjRH7ZkdIxulKe1g==


app.publicKey=
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDSwmvBMn4HsP5jwjLarW96LjdWgIwWcX5Wu8sGxFCiE9Ch8GKbMvFpUjpuUXYV0N1SlzOJGJynblhx22WBSYEUPckrGDnGiUD/TC+/drGASLvg2ANmlnCgFjgktCSfqXTe3YljkKM3/rOBZbBYSDSXCD3ey9TSlTEHf+/dxvaR3QIDAQAB
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDSwmvBMn4HsP5jwjLarW96LjdWgIwWcX5Wu8sGxFCiE9Ch8GKbMvFpUjpuUXYV0N1SlzOJGJynblhx22WBSYEUPckrGDnGiUD/TC+/drGASLvg2ANmlnCgFjgktCSfqXTe3YljkKM3/rOBZbBYSDSXCD3ey9TSlTEHf+/dxvaR3QIDAQAB

MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDQeivicgFn5KYCtCa+RztsKNezi9iR0Sp8lbUcf9tTnlw9XckEwHWP8Zv0/oKrl1O0zVJ6ZMF1270+k+wizNYg6SgqsGBOKCLtVusgyMfUtH5Oy+w8sZbzfvBa+S+myx6pb3Qm9xz7/g74ru5/4xeXGCJRTOqsaUQir0x++DvZGwIDAQAB
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDQeivicgFn5KYCtCa+RztsKNezi9iR0Sp8lbUcf9tTnlw9XckEwHWP8Zv0/oKrl1O0zVJ6ZMF1270+k+wizNYg6SgqsGBOKCLtVusgyMfUtH5Oy+w8sZbzfvBa+S+myx6pb3Qm9xz7/g74ru5/4xeXGCJRTOqsaUQir0x++DvZGwIDAQAB
aibank.publicKey=
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDd0MAGJs11vqk0n8QllKJTKnIoL8r+hXuGKPl6EP74XQI+fe8Oy/krbPVrhtHxBUxJ/EzKciGdGd+JO8yTjG/kI3G5pzSrfF4afMgXy4wc8itz0Gcs+ig7jzr670s4VPHHEEpe63oWjXKFkJ3yEfzu6bVScUZeQI1URH6wVfrpwwIDAQAB

